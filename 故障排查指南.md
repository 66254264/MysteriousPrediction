# Failed to Fetch 错误排查指南

## 🔴 问题：点击按钮后报错 "Failed to fetch"

这个错误表示前端无法连接到后端API。以下是完整的排查和解决步骤。

---

## ✅ 快速解决方案

### 1. 确保后端服务正在运行

```bash
# 在 backend 目录下运行
cd backend
npm run dev
```

**预期输出：**
```
✅ MongoDB connected successfully
✅ Database indexes created successfully
Server running on port 5000
```

### 2. 确保前端服务正在运行

```bash
# 在 frontend 目录下运行
cd frontend
npm run dev
```

**预期输出：**
```
VITE v5.x.x ready in xxx ms
➜  Local:   http://localhost:3000/
```

### 3. 检查MongoDB是否运行

```bash
# Windows
net start MongoDB

# 或者检查服务状态
sc query MongoDB
```

如果MongoDB未安装或未运行，请先安装并启动MongoDB。

---

## 🔍 详细排查步骤

### 步骤1：检查后端服务状态

#### 方法A：使用浏览器
打开浏览器访问：`http://localhost:5000/api/system/health`

**成功响应示例：**
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "timestamp": "2025-10-28T...",
    "uptime": 123.45
  }
}
```

#### 方法B：使用curl
```bash
curl http://localhost:5000/api/system/health
```

#### 方法C：使用诊断工具
打开 `test-connection.html` 文件在浏览器中，点击"测试后端"按钮。

### 步骤2：检查端口占用

```bash
# Windows - 检查5000端口
netstat -ano | findstr :5000

# 如果端口被占用，找到PID并结束进程
taskkill /PID <PID> /F
```

### 步骤3：检查CORS配置

**后端配置** (`backend/.env`):
```env
CORS_ORIGIN=http://localhost:3000
```

**前端配置** (`frontend/.env`):
```env
VITE_API_URL=http://localhost:5000/api
```

**重要：** 确保CORS_ORIGIN与前端运行的地址匹配！

### 步骤4：检查防火墙

Windows防火墙可能阻止本地连接：

1. 打开 Windows Defender 防火墙
2. 点击"允许应用通过防火墙"
3. 确保 Node.js 被允许

或者临时关闭防火墙测试：
```bash
# 需要管理员权限
netsh advfirewall set allprofiles state off
```

### 步骤5：检查网络配置

在浏览器控制台运行：
```javascript
// 检查网络状态
console.log('在线状态:', navigator.onLine)

// 测试API连接
fetch('http://localhost:5000/api/system/health')
  .then(r => r.json())
  .then(d => console.log('API响应:', d))
  .catch(e => console.error('API错误:', e))
```

---

## 🐛 常见错误和解决方案

### 错误1: "Failed to fetch"
**原因：** 后端服务未运行

**解决：**
```bash
cd backend
npm run dev
```

### 错误2: "EADDRINUSE: address already in use"
**原因：** 端口5000已被占用

**解决：**
```bash
# 找到占用端口的进程
netstat -ano | findstr :5000

# 结束进程
taskkill /PID <PID> /F

# 或者修改端口
# 在 backend/.env 中修改 PORT=5001
```

### 错误3: "CORS policy: No 'Access-Control-Allow-Origin'"
**原因：** CORS配置不正确

**解决：**
1. 检查 `backend/.env` 中的 `CORS_ORIGIN`
2. 确保值为 `http://localhost:3000`（前端运行的地址）
3. 重启后端服务

### 错误4: "MongooseServerSelectionError"
**原因：** MongoDB未运行或连接失败

**解决：**
```bash
# 启动MongoDB服务
net start MongoDB

# 或者检查 backend/.env 中的 MONGODB_URI
MONGODB_URI=mongodb://localhost:27017/fortune-prediction
```

### 错误5: "Cannot GET /api/..."
**原因：** API路由不存在

**解决：**
1. 检查API路径是否正确
2. 查看后端日志确认路由已注册
3. 确保使用正确的HTTP方法（GET/POST等）

### 错误6: "Request timeout"
**原因：** 请求超时（>10秒）

**解决：**
1. 检查网络连接
2. 检查后端性能
3. 增加超时时间（在 `frontend/src/services/api.ts`）

---

## 📊 使用诊断工具

### 方法1：使用test-connection.html

1. 在浏览器中打开 `test-connection.html`
2. 页面会自动运行所有测试
3. 查看每个测试的结果

### 方法2：使用浏览器开发者工具

1. 打开前端应用（http://localhost:3000）
2. 按 F12 打开开发者工具
3. 切换到 Network 标签
4. 点击占卜按钮
5. 查看失败的请求详情

**检查项：**
- Status Code（状态码）
- Response（响应内容）
- Headers（请求头）
- Timing（时间）

### 方法3：查看后端日志

后端日志会显示所有请求：
```
[2025-10-28T...] [INFO] POST /api/divination/tarot
[2025-10-28T...] [INFO] Response time: 1234ms
```

---

## 🔧 配置检查清单

### 后端配置 (backend/.env)
- [ ] PORT=5000
- [ ] NODE_ENV=development
- [ ] MONGODB_URI=mongodb://localhost:27017/fortune-prediction
- [ ] JWT_SECRET=（已设置）
- [ ] CORS_ORIGIN=http://localhost:3000

### 前端配置 (frontend/.env)
- [ ] VITE_API_URL=http://localhost:5000/api

### 服务状态
- [ ] MongoDB 正在运行
- [ ] 后端服务正在运行（端口5000）
- [ ] 前端服务正在运行（端口3000）
- [ ] 防火墙允许连接

### 网络测试
- [ ] 可以访问 http://localhost:5000/api/system/health
- [ ] 可以访问 http://localhost:3000
- [ ] CORS 配置正确
- [ ] 无端口冲突

---

## 🚀 完整启动流程

### 1. 启动MongoDB
```bash
# Windows
net start MongoDB

# 验证
mongo --eval "db.version()"
```

### 2. 启动后端
```bash
cd backend
npm install  # 首次运行
npm run dev
```

**等待看到：**
```
✅ MongoDB connected successfully
Server running on port 5000
```

### 3. 启动前端
```bash
cd frontend
npm install  # 首次运行
npm run dev
```

**等待看到：**
```
➜  Local:   http://localhost:3000/
```

### 4. 测试连接
打开浏览器访问：
- 前端：http://localhost:3000
- 后端健康检查：http://localhost:5000/api/system/health
- 诊断工具：打开 test-connection.html

---

## 💡 开发技巧

### 1. 使用并发启动
创建 `start-all.bat`：
```batch
@echo off
start cmd /k "cd backend && npm run dev"
timeout /t 5
start cmd /k "cd frontend && npm run dev"
start http://localhost:3000
```

### 2. 监控日志
```bash
# 后端日志
cd backend
npm run dev | tee backend.log

# 前端日志
cd frontend
npm run dev | tee frontend.log
```

### 3. 快速重启
```bash
# 停止所有Node进程
taskkill /F /IM node.exe

# 重新启动
cd backend && npm run dev
cd frontend && npm run dev
```

---

## 📞 仍然无法解决？

### 收集诊断信息

1. **后端日志**
   - 复制后端控制台的完整输出

2. **前端错误**
   - 打开浏览器控制台（F12）
   - 复制 Console 和 Network 标签的错误信息

3. **环境信息**
   ```bash
   node --version
   npm --version
   mongo --version
   ```

4. **端口状态**
   ```bash
   netstat -ano | findstr :5000
   netstat -ano | findstr :3000
   netstat -ano | findstr :27017
   ```

5. **配置文件**
   - backend/.env
   - frontend/.env

### 提交问题时包含：
- 错误截图
- 完整的错误消息
- 后端和前端日志
- 环境信息
- 已尝试的解决步骤

---

## ✅ 成功标志

当一切正常时，你应该看到：

1. **后端控制台：**
   ```
   ✅ MongoDB connected successfully
   ✅ Database indexes created successfully
   Server running on port 5000
   ```

2. **前端控制台：**
   ```
   VITE v5.x.x ready in xxx ms
   ➜  Local:   http://localhost:3000/
   ```

3. **浏览器：**
   - 可以访问 http://localhost:3000
   - 点击占卜按钮正常工作
   - Network 标签显示 200 状态码
   - 无 CORS 错误

4. **健康检查：**
   - http://localhost:5000/api/system/health 返回 healthy

---

**祝你好运！如果问题仍然存在，请使用 test-connection.html 诊断工具获取详细信息。** 🎉

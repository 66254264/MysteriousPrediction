# 运行指南 - 算命预测网站

## 最新更新 ✅

已修复以下问题：
- ✅ 塔罗牌占卜 - 修复了 spreadType 格式转换问题
- ✅ 生辰八字 - 修复了 birthTime 格式转换问题（字符串 → 对象）
- ✅ 易经占卜 - 修复了 method 参数值问题（number → numbers）
- ✅ 星座运势 - 正常工作

## 前置要求

在运行项目之前，请确保已安装：
- **Node.js** (v18 或更高版本)
- **MongoDB** (v6 或更高版本)
- **npm** 或 **yarn** 包管理器

## 快速启动

### 方式一：使用启动脚本（推荐）

根据你的系统选择：

**选项 A - 简单批处理脚本（推荐）**
```bash
双击运行 start-simple.bat
```

**选项 B - 完整批处理脚本**
```bash
双击运行 start.bat
```

**选项 C - PowerShell 脚本**
```powershell
右键 start.ps1 -> 使用 PowerShell 运行
# 或在 PowerShell 中执行：
.\start.ps1
```

所有脚本都会自动：
1. 检查 MongoDB 状态
2. 启动后端服务器（新窗口）
3. 启动前端服务器（新窗口）

### 方式二：手动启动

### 1. 启动 MongoDB 数据库

首先确保 MongoDB 正在运行：

```bash
# Windows (如果 MongoDB 已安装为服务)
net start MongoDB

# 或者手动启动
mongod
```

### 2. 安装依赖

#### 后端依赖
```bash
cd backend
npm install
```

#### 前端依赖
```bash
cd frontend
npm install
```

### 3. 启动后端服务器

在 `backend` 目录下：

```bash
npm run dev
```

后端服务器将在 **http://localhost:5000** 启动

你应该看到类似的输出：
```
[2024-XX-XX] [INFO] Database connected successfully
[2024-XX-XX] [INFO] Server running on port 5000
```

### 4. 启动前端开发服务器

在新的终端窗口中，进入 `frontend` 目录：

```bash
npm run dev
```

前端服务器将在 **http://localhost:3000** 启动（或 Vite 分配的其他端口）

## 测试新功能

### 测试错误处理

1. **测试 ErrorBoundary（错误边界）**
   - 打开浏览器开发者工具
   - 在控制台中手动触发错误来测试错误边界

2. **测试 API 错误处理**
   - 尝试使用错误的凭据登录
   - 查看用户友好的错误提示

3. **测试网络错误**
   - 在浏览器开发者工具中切换到离线模式（Network > Offline）
   - 应该看到"网络连接已断开"的提示条

### 测试系统监控

1. **健康检查端点**
   ```bash
   # 在浏览器或使用 curl 访问
   curl http://localhost:5000/api/system/health
   ```
   
   你会看到系统健康状态，包括：
   - 数据库连接状态
   - 内存使用情况
   - CPU 使用率
   - 系统运行时间

2. **查看系统指标**（需要登录）
   ```bash
   curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost:5000/api/system/metrics
   ```

3. **前端系统状态组件**
   - 可以在任何页面添加 `<SystemStatus showDetails={true} />` 组件来查看实时系统状态

### 测试日志系统

查看后端终端，你会看到结构化的日志输出：

```
[2024-XX-XX] [INFO] Incoming request
Context: {
  "requestId": "req_xxx",
  "method": "GET",
  "path": "/api/system/health"
}

[2024-XX-XX] [INFO] Request completed
Context: {
  "requestId": "req_xxx",
  "statusCode": 200,
  "duration": "15ms"
}
```

## 常见问题

### MongoDB 连接失败

如果看到数据库连接错误：
1. 确保 MongoDB 正在运行
2. 检查 `backend/.env` 中的 `MONGODB_URI` 配置
3. 默认连接地址：`mongodb://localhost:27017/fortune-prediction`

### 端口被占用

如果端口 5000 或 3000 被占用：
- 修改 `backend/.env` 中的 `PORT`
- 修改 `frontend/.env` 中的 `VITE_API_URL`

### CORS 错误

如果遇到跨域问题：
- 确保 `backend/.env` 中的 `CORS_ORIGIN` 与前端地址匹配
- 默认：`http://localhost:3000`

## 生产环境部署

### 构建后端
```bash
cd backend
npm run build
npm start
```

### 构建前端
```bash
cd frontend
npm run build
```

构建产物在 `frontend/dist` 目录中。

## 功能演示路径

1. **注册/登录** → http://localhost:3000/register
2. **首页** → http://localhost:3000/
3. **塔罗牌占卜** → http://localhost:3000/divination/tarot
4. **星座运势** → http://localhost:3000/divination/astrology
5. **八字算命** → http://localhost:3000/divination/bazi
6. **易经占卜** → http://localhost:3000/divination/yijing
7. **个人资料** → http://localhost:3000/profile

## 监控和调试

### 查看实时日志
- 后端日志会在终端实时显示
- 前端错误会在浏览器控制台显示

### 性能监控
- 打开浏览器开发者工具 → Performance 标签
- 使用 `window.performance` API 查看性能指标

### 网络监控
- 开发者工具 → Network 标签
- 查看 API 请求响应时间和状态

## 停止服务

在各自的终端窗口中按 `Ctrl + C` 停止服务器。

---

**提示**: 首次运行时，数据库是空的。你需要先注册一个账户才能使用占卜功能。

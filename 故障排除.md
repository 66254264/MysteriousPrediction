# 故障排除指南

## 启动脚本问题

### 问题 1: "找不到 backend 或 frontend 目录"

**原因**: 脚本无法找到项目目录

**解决方案**:
1. 确保你在项目根目录运行脚本
2. 检查目录结构：
   ```
   项目根目录/
   ├── backend/
   ├── frontend/
   ├── start.bat
   └── start-simple.bat
   ```
3. 使用 `start-simple.bat` 而不是 `start.bat`
4. 或者手动启动（见下方）

### 问题 2: PowerShell 执行策略错误

**错误信息**: "无法加载文件...因为在此系统上禁止运行脚本"

**解决方案**:
```powershell
# 方案 1: 临时允许（推荐）
Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

# 方案 2: 使用批处理脚本
双击 start-simple.bat

# 方案 3: 手动启动（见下方）
```

### 问题 3: npm 命令不可用

**错误信息**: "npm 不是内部或外部命令"

**解决方案**:
1. 确保已安装 Node.js
2. 重启终端/命令提示符
3. 检查 Node.js 安装：
   ```bash
   node --version
   npm --version
   ```

## 手动启动（最可靠的方法）

### Windows CMD

**终端 1 - 后端**:
```cmd
cd backend
npm run dev
```

**终端 2 - 前端**（打开新的 CMD 窗口）:
```cmd
cd frontend
npm run dev
```

### Windows PowerShell

**终端 1 - 后端**:
```powershell
cd backend
npm run dev
```

**终端 2 - 前端**（打开新的 PowerShell 窗口）:
```powershell
cd frontend
npm run dev
```

## MongoDB 问题

### 问题: MongoDB 连接失败

**错误信息**: "Failed to connect to MongoDB"

**解决方案**:

1. **检查 MongoDB 是否运行**:
   ```bash
   # Windows
   net start MongoDB
   
   # 或查看服务状态
   sc query MongoDB
   ```

2. **手动启动 MongoDB**:
   ```bash
   # 如果安装了 MongoDB
   mongod
   ```

3. **检查连接字符串**:
   - 打开 `backend/.env`
   - 确认 `MONGODB_URI=mongodb://localhost:27017/fortune-prediction`

4. **安装 MongoDB**（如果未安装）:
   - 下载: https://www.mongodb.com/try/download/community
   - 或使用 MongoDB Atlas（云数据库）

### 问题: MongoDB 未安装

**解决方案**:

**选项 A - 安装本地 MongoDB**:
1. 访问 https://www.mongodb.com/try/download/community
2. 下载并安装 MongoDB Community Edition
3. 启动 MongoDB 服务

**选项 B - 使用 MongoDB Atlas（云数据库）**:
1. 注册 https://www.mongodb.com/cloud/atlas
2. 创建免费集群
3. 获取连接字符串
4. 更新 `backend/.env` 中的 `MONGODB_URI`

## 端口占用问题

### 问题: 端口 5000 或 3000 被占用

**错误信息**: "Port 5000 is already in use"

**解决方案**:

1. **查找占用端口的进程**:
   ```bash
   # Windows
   netstat -ano | findstr :5000
   netstat -ano | findstr :3000
   ```

2. **终止进程**:
   ```bash
   # Windows (使用上一步找到的 PID)
   taskkill /PID <进程ID> /F
   ```

3. **更改端口**:
   - 后端: 修改 `backend/.env` 中的 `PORT`
   - 前端: Vite 会自动选择可用端口

## 依赖安装问题

### 问题: 缺少依赖包

**错误信息**: "Cannot find module 'xxx'"

**解决方案**:

```bash
# 重新安装后端依赖
cd backend
rm -rf node_modules package-lock.json
npm install

# 重新安装前端依赖
cd frontend
rm -rf node_modules package-lock.json
npm install
```

## API 调用问题

### 问题: "Invalid input data" 错误

**已修复**: 这个问题已经在最新版本中修复

**验证修复**:
1. 确保使用最新代码
2. 检查以下文件是否已更新：
   - `frontend/src/pages/TarotPage.tsx`
   - `frontend/src/pages/BaziPage.tsx`
   - `frontend/src/pages/YijingPage.tsx`
   - `frontend/src/services/api.ts`

### 问题: 网络请求失败

**解决方案**:

1. **检查后端是否运行**:
   - 访问 http://localhost:5000/api/system/health
   - 应该返回 JSON 响应

2. **检查 CORS 配置**:
   - 打开 `backend/.env`
   - 确认 `CORS_ORIGIN=http://localhost:3000`

3. **检查前端 API 地址**:
   - 打开 `frontend/.env`
   - 确认 `VITE_API_URL=http://localhost:5000/api`

## 浏览器问题

### 问题: 页面空白或样式错误

**解决方案**:

1. **清除浏览器缓存**:
   - Chrome: Ctrl + Shift + Delete
   - 选择"缓存的图片和文件"
   - 点击"清除数据"

2. **硬刷新页面**:
   - Windows: Ctrl + F5
   - Mac: Cmd + Shift + R

3. **检查控制台错误**:
   - 按 F12 打开开发者工具
   - 查看 Console 标签中的错误信息

## 获取帮助

如果以上方法都无法解决问题：

1. **查看日志**:
   - 后端日志在后端终端窗口
   - 前端日志在浏览器控制台（F12）

2. **检查文档**:
   - `运行指南.md` - 详细运行说明
   - `修复说明.md` - 已知问题和修复
   - `快速参考.md` - 快速参考指南

3. **常见错误代码**:
   - 400: 请求数据格式错误
   - 401: 未登录或 token 过期
   - 404: 路由不存在
   - 500: 服务器内部错误

## 验证安装

运行以下命令验证环境：

```bash
# 检查 Node.js
node --version
# 应该显示 v18.x.x 或更高

# 检查 npm
npm --version
# 应该显示 9.x.x 或更高

# 检查 MongoDB（如果已安装）
mongod --version
# 应该显示 MongoDB 版本信息
```

## 完全重置

如果一切都不工作，尝试完全重置：

```bash
# 1. 停止所有服务
# 关闭所有终端窗口

# 2. 清理依赖
cd backend
rm -rf node_modules package-lock.json
cd ../frontend
rm -rf node_modules package-lock.json

# 3. 重新安装
cd ../backend
npm install
cd ../frontend
npm install

# 4. 重新启动
# 使用 start-simple.bat 或手动启动
```

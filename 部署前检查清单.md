# 部署前检查清单

## ✅ 代码质量检查

### 前端 (Frontend)
- [ ] 运行 `npm run build` 无错误
- [ ] 运行 `npm run lint` 无错误
- [ ] TypeScript编译通过
- [ ] 所有组件正常渲染
- [ ] 环境变量配置正确

```bash
cd frontend
npm install
npm run build
npm run lint
```

### 后端 (Backend)
- [ ] 运行 `npm run build` 无错误
- [ ] 运行 `npm run lint` 无错误
- [ ] TypeScript编译通过
- [ ] 数据库连接正常
- [ ] 环境变量配置正确

```bash
cd backend
npm install
npm run build
npm run lint
```

## ✅ 功能测试

### 网络功能
- [ ] 正常网络请求成功
- [ ] 超时自动重试
- [ ] 离线提示显示
- [ ] 网络恢复后正常
- [ ] 慢速网络警告
- [ ] 错误提示友好

### API功能
- [ ] 用户注册/登录
- [ ] 塔罗牌占卜
- [ ] 星座预测
- [ ] 八字算命
- [ ] 周易占卜
- [ ] 历史记录查询

### 缓存功能
- [ ] 缓存正常工作
- [ ] 缓存命中率>50%
- [ ] 缓存自动失效
- [ ] 缓存统计可查看

## ✅ 性能测试

### 响应时间
- [ ] 首次请求 <2秒
- [ ] 缓存命中 <500ms
- [ ] 超时保护 10秒
- [ ] 平均响应 <5秒

### 并发测试
```bash
# 使用Apache Bench测试
ab -n 100 -c 10 http://your-api-url/system/health
```
- [ ] 成功率 100%
- [ ] 平均响应 <500ms
- [ ] 无错误

### 负载测试
```bash
# 使用k6或JMeter测试
# 模拟100+并发用户
```
- [ ] 支持100+并发
- [ ] 无性能下降
- [ ] 无内存泄漏

## ✅ 安全检查

### 前端
- [ ] API密钥不在代码中
- [ ] 使用HTTPS
- [ ] CORS配置正确
- [ ] XSS防护
- [ ] CSRF防护

### 后端
- [ ] 环境变量安全
- [ ] JWT密钥强度
- [ ] 密码加密
- [ ] SQL注入防护
- [ ] 速率限制

## ✅ 配置检查

### 前端环境变量 (.env)
```bash
VITE_API_URL=https://your-api-url/api
```
- [ ] API URL正确
- [ ] 使用生产环境URL

### 后端环境变量 (.env)
```bash
NODE_ENV=production
PORT=5000
MONGODB_URI=mongodb://...
JWT_SECRET=your-strong-secret
CORS_ORIGIN=https://your-frontend-url
```
- [ ] NODE_ENV=production
- [ ] MongoDB URI正确
- [ ] JWT密钥强度足够
- [ ] CORS配置正确

## ✅ 数据库检查

### MongoDB
- [ ] 数据库连接正常
- [ ] 索引已创建
- [ ] 备份策略就绪
- [ ] 连接池配置正确

```bash
# 检查索引
mongo your-database --eval "db.users.getIndexes()"
mongo your-database --eval "db.predictionrecords.getIndexes()"
```

## ✅ 监控和日志

### 监控端点
- [ ] `/api/system/health` 可访问
- [ ] `/api/system/cache` 返回正确
- [ ] `/api/system/performance` 返回正确
- [ ] `/api/system/database` 返回正确

### 日志
- [ ] 错误日志正常记录
- [ ] 访问日志正常记录
- [ ] 日志级别正确
- [ ] 日志轮转配置

## ✅ 文档检查

- [ ] README.md 更新
- [ ] API文档完整
- [ ] 部署文档完整
- [ ] 故障排查文档

## ✅ 备份和恢复

### 数据备份
- [ ] 数据库备份策略
- [ ] 定期备份测试
- [ ] 恢复流程文档

### 代码备份
- [ ] Git仓库推送
- [ ] 标签版本创建
- [ ] 回滚计划就绪

## ✅ 部署步骤

### 1. 准备阶段
```bash
# 1. 拉取最新代码
git pull origin main

# 2. 安装依赖
cd frontend && npm install
cd ../backend && npm install

# 3. 构建
cd frontend && npm run build
cd ../backend && npm run build
```

### 2. 测试阶段
```bash
# 1. 运行测试
npm test

# 2. 检查构建产物
ls -la frontend/dist
ls -la backend/dist
```

### 3. 部署阶段
```bash
# 1. 停止旧服务
pm2 stop fortune-backend

# 2. 部署新代码
# (根据你的部署方式)

# 3. 启动新服务
pm2 start backend/dist/server.js --name fortune-backend

# 4. 检查状态
pm2 status
pm2 logs fortune-backend
```

### 4. 验证阶段
```bash
# 1. 健康检查
curl https://your-api-url/api/system/health

# 2. 功能测试
# 访问前端，测试主要功能

# 3. 监控检查
curl https://your-api-url/api/system/performance
```

## ✅ 部署后验证

### 立即检查（部署后5分钟）
- [ ] 网站可访问
- [ ] API响应正常
- [ ] 数据库连接正常
- [ ] 无错误日志

### 短期检查（部署后1小时）
- [ ] 响应时间正常
- [ ] 缓存工作正常
- [ ] 无内存泄漏
- [ ] 用户反馈正常

### 长期监控（部署后24小时）
- [ ] 系统稳定运行
- [ ] 性能指标正常
- [ ] 错误率<1%
- [ ] 用户满意度高

## ✅ 回滚计划

### 触发条件
- 错误率>5%
- 响应时间>10秒
- 系统崩溃
- 数据丢失

### 回滚步骤
```bash
# 1. 停止新服务
pm2 stop fortune-backend

# 2. 恢复旧版本
git checkout previous-version
npm install
npm run build

# 3. 启动旧服务
pm2 start backend/dist/server.js

# 4. 验证
curl https://your-api-url/api/system/health
```

## 📞 紧急联系

### 技术支持
- 开发团队：[联系方式]
- 运维团队：[联系方式]
- 数据库管理员：[联系方式]

### 监控告警
- 错误告警：[告警渠道]
- 性能告警：[告警渠道]
- 可用性告警：[告警渠道]

## 📝 部署记录

```
部署日期: ____________________
部署人员: ____________________
版本号: ____________________

检查项完成情况:
- 代码质量: ☐ 通过
- 功能测试: ☐ 通过
- 性能测试: ☐ 通过
- 安全检查: ☐ 通过
- 配置检查: ☐ 通过
- 数据库检查: ☐ 通过

部署结果: ☐ 成功 ☐ 失败 ☐ 回滚

问题记录:
_________________________________
_________________________________
_________________________________

签名: ____________________
```

---

**重要提示：**
1. 所有检查项必须通过才能部署
2. 保留回滚能力至少24小时
3. 密切监控部署后的系统状态
4. 及时响应用户反馈
